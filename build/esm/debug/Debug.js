import { DEFAULT_POSITION, DEFAULT_SIZE as size } from './constants';
/**
 * @exports Debug - methods and helpers for debugging System emitters, zones and particles.
 * @requires THREE - { SphereGeometry, BoxGeometry, MeshBasicMaterial, OctahedronGeometry, Mesh }
 */

export default {
  /**
   * Adds an event listener to the system instance's SYSTEM_UPDATE event.
   *
   * @param {System} system - the system instance
   * @param {function} onSystemUpdated - the function to call when system has been updated
   * @return {Debug}
   */
  addEventListener: function (system, onSystemUpdated) {
    system.eventDispatcher.addEventListener('SYSTEM_UPDATE', onSystemUpdated);
    return this;
  },

  /**
   * Draws a wireframe mesh around the zone for debugging purposes.
   *
   * @param {System} system - the system instance
   * @param {object} container - a three Object3D (usually the scene)
   * @param {Zone} zone - a Zone instance
   * @return void
   */
  drawZone: function (THREE, system, container, zone = {}) {
    const color = '#2194ce';
    const wireframe = true;
    const {
      width = size,
      height = size,
      depth = size,
      radius = size,
      x = DEFAULT_POSITION,
      y = DEFAULT_POSITION,
      z = DEFAULT_POSITION
    } = zone;
    let geometry;

    if (zone.isPointZone()) {
      geometry = new THREE.SphereGeometry(15);
    }

    if (zone.isLineZone()) {// TODO
    }

    if (zone.isBoxZone()) {
      geometry = new THREE.BoxGeometry(width, height, depth);
    }

    if (zone.isSphereZone()) {
      geometry = new THREE.SphereGeometry(radius, size, size);
    }

    if (zone.isMeshZone()) {
      geometry = zone.geometry.geometry ? zone.geometry.geometry.clone() : zone.geometry.clone();
    }

    if (!geometry) {
      geometry = new THREE.BoxGeometry(width, height, depth);
    }

    const material = new THREE.MeshBasicMaterial({
      color,
      wireframe
    }); // NOTE! geometry.clone is required for UNKNOWN reasons,
    // three does not render the mesh correctly without doing this since r88

    const mesh = new THREE.Mesh(geometry.clone(), material);
    container.add(mesh);
    this.addEventListener(system, function () {
      mesh.position.set(x, y, z);
    });
  },

  /**
   * Draws a mesh for each particle emitted in order to help debug particles.
   *
   * @param {object} system - the system instance
   * @param {object} container - a three Object3D (usually the scene)
   * @param {object} emitter - the emitter to debug
   * @param {string} color - the color for the debug mesh material
   * @return void
   */
  drawEmitter: function (THREE, system, container, emitter, color) {
    const geometry = new THREE.OctahedronGeometry(size);
    const material = new THREE.MeshBasicMaterial({
      color: color || '#aaa',
      wireframe: true
    }); // NOTE! geometry.clone is required for UNKNOWN reasons,
    // three does not render the mesh correctly without doing this since r88

    const mesh = new THREE.Mesh(geometry.clone(), material);
    container.add(mesh);
    this.addEventListener(system, function () {
      mesh.position.copy(emitter.position);
      mesh.rotation.set(emitter.rotation.x, emitter.rotation.y, emitter.rotation.z);
    });
  },

  /**
   * Renders emitter / particle information into the info element.
   *
   * @param {object} system - the system instance
   * @param {integer} style - style to apply (see the addInfo method's switch statement)
   * @return void
   */
  renderInfo: function () {
    function getCreatedNumber(type, system) {
      var pool = type == 'material' ? '_materialPool' : '_targetPool';
      var renderer = system.renderers[0];
      return renderer[pool].cID;
    }

    function getEmitterPos(system) {
      var e = system.emitters[0];
      return Math.round(e.p.x) + ',' + Math.round(e.p.y) + ',' + Math.round(e.p.z);
    }

    return function (system, style) {
      this.addInfo(style);
      var str = '';

      switch (this._infoType) {
        case 2:
          str += 'emitter:' + system.emitters.length + '<br>';
          str += 'em speed:' + system.emitters[0].cID + '<br>';
          str += 'pos:' + getEmitterPos(system);
          break;

        case 3:
          str += system.renderers[0].name + '<br>';
          str += 'target:' + getCreatedNumber('target') + '<br>';
          str += 'material:' + getCreatedNumber('material');
          break;

        default:
          str += 'particles:' + system.getCount() + '<br>';
          str += 'pool:' + system.pool.getCount() + '<br>';
          str += 'total:' + (system.getCount() + system.pool.getCount());
      }

      this._infoCon.innerHTML = str;
    };
  }(),

  /**
   * Appends the info element into the dom.
   *
   * @param {integer} style - the style type to apply
   * @return void
   */
  addInfo: function () {
    return function (style) {
      var self = this;

      if (!this._infoCon) {
        this._infoCon = document.createElement('div');
        this._infoCon.style.cssText = ['position:fixed;bottom:0px;left:0;cursor:pointer;', 'opacity:0.9;z-index:10000;padding:10px;font-size:12px;', 'width:120px;height:50px;background-color:#002;color:#0ff;'].join('');
        this._infoType = 1;

        this._infoCon.addEventListener('click', function () {
          self._infoType++;
          if (self._infoType > 3) self._infoType = 1;
        }, false);

        var bg, color;

        switch (style) {
          case 2:
            bg = '#201';
            color = '#f08';
            break;

          case 3:
            bg = '#020';
            color = '#0f0';
            break;

          default:
            bg = '#002';
            color = '#0ff';
        }

        this._infoCon.style['background-color'] = bg;
        this._infoCon.style['color'] = color;
      }

      if (!this._infoCon.parentNode) document.body.appendChild(this._infoCon);
    };
  }()
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kZWJ1Zy9EZWJ1Zy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1BPU0lUSU9OIiwiREVGQVVMVF9TSVpFIiwic2l6ZSIsImFkZEV2ZW50TGlzdGVuZXIiLCJzeXN0ZW0iLCJvblN5c3RlbVVwZGF0ZWQiLCJldmVudERpc3BhdGNoZXIiLCJkcmF3Wm9uZSIsIlRIUkVFIiwiY29udGFpbmVyIiwiem9uZSIsImNvbG9yIiwid2lyZWZyYW1lIiwid2lkdGgiLCJoZWlnaHQiLCJkZXB0aCIsInJhZGl1cyIsIngiLCJ5IiwieiIsImdlb21ldHJ5IiwiaXNQb2ludFpvbmUiLCJTcGhlcmVHZW9tZXRyeSIsImlzTGluZVpvbmUiLCJpc0JveFpvbmUiLCJCb3hHZW9tZXRyeSIsImlzU3BoZXJlWm9uZSIsImlzTWVzaFpvbmUiLCJjbG9uZSIsIm1hdGVyaWFsIiwiTWVzaEJhc2ljTWF0ZXJpYWwiLCJtZXNoIiwiTWVzaCIsImFkZCIsInBvc2l0aW9uIiwic2V0IiwiZHJhd0VtaXR0ZXIiLCJlbWl0dGVyIiwiT2N0YWhlZHJvbkdlb21ldHJ5IiwiY29weSIsInJvdGF0aW9uIiwicmVuZGVySW5mbyIsImdldENyZWF0ZWROdW1iZXIiLCJ0eXBlIiwicG9vbCIsInJlbmRlcmVyIiwicmVuZGVyZXJzIiwiY0lEIiwiZ2V0RW1pdHRlclBvcyIsImUiLCJlbWl0dGVycyIsIk1hdGgiLCJyb3VuZCIsInAiLCJzdHlsZSIsImFkZEluZm8iLCJzdHIiLCJfaW5mb1R5cGUiLCJsZW5ndGgiLCJuYW1lIiwiZ2V0Q291bnQiLCJfaW5mb0NvbiIsImlubmVySFRNTCIsInNlbGYiLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJjc3NUZXh0Iiwiam9pbiIsImJnIiwicGFyZW50Tm9kZSIsImJvZHkiLCJhcHBlbmRDaGlsZCJdLCJtYXBwaW5ncyI6IkFBQUEsU0FBU0EsZ0JBQVQsRUFBMkJDLFlBQVksSUFBSUMsSUFBM0MsUUFBdUQsYUFBdkQ7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFDQSxlQUFlO0FBQ2I7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDRUMsRUFBQUEsZ0JBQWdCLEVBQUUsVUFBU0MsTUFBVCxFQUFpQkMsZUFBakIsRUFBa0M7QUFDbERELElBQUFBLE1BQU0sQ0FBQ0UsZUFBUCxDQUF1QkgsZ0JBQXZCLENBQXdDLGVBQXhDLEVBQXlERSxlQUF6RDtBQUVBLFdBQU8sSUFBUDtBQUNELEdBWlk7O0FBY2I7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNFRSxFQUFBQSxRQUFRLEVBQUUsVUFBU0MsS0FBVCxFQUFnQkosTUFBaEIsRUFBd0JLLFNBQXhCLEVBQW1DQyxJQUFJLEdBQUcsRUFBMUMsRUFBOEM7QUFDdEQsVUFBTUMsS0FBSyxHQUFHLFNBQWQ7QUFDQSxVQUFNQyxTQUFTLEdBQUcsSUFBbEI7QUFDQSxVQUFNO0FBQ0pDLE1BQUFBLEtBQUssR0FBR1gsSUFESjtBQUVKWSxNQUFBQSxNQUFNLEdBQUdaLElBRkw7QUFHSmEsTUFBQUEsS0FBSyxHQUFHYixJQUhKO0FBSUpjLE1BQUFBLE1BQU0sR0FBR2QsSUFKTDtBQUtKZSxNQUFBQSxDQUFDLEdBQUdqQixnQkFMQTtBQU1Ka0IsTUFBQUEsQ0FBQyxHQUFHbEIsZ0JBTkE7QUFPSm1CLE1BQUFBLENBQUMsR0FBR25CO0FBUEEsUUFRRlUsSUFSSjtBQVVBLFFBQUlVLFFBQUo7O0FBRUEsUUFBSVYsSUFBSSxDQUFDVyxXQUFMLEVBQUosRUFBd0I7QUFDdEJELE1BQUFBLFFBQVEsR0FBRyxJQUFJWixLQUFLLENBQUNjLGNBQVYsQ0FBeUIsRUFBekIsQ0FBWDtBQUNEOztBQUVELFFBQUlaLElBQUksQ0FBQ2EsVUFBTCxFQUFKLEVBQXVCLENBQ3JCO0FBQ0Q7O0FBRUQsUUFBSWIsSUFBSSxDQUFDYyxTQUFMLEVBQUosRUFBc0I7QUFDcEJKLE1BQUFBLFFBQVEsR0FBRyxJQUFJWixLQUFLLENBQUNpQixXQUFWLENBQXNCWixLQUF0QixFQUE2QkMsTUFBN0IsRUFBcUNDLEtBQXJDLENBQVg7QUFDRDs7QUFFRCxRQUFJTCxJQUFJLENBQUNnQixZQUFMLEVBQUosRUFBeUI7QUFDdkJOLE1BQUFBLFFBQVEsR0FBRyxJQUFJWixLQUFLLENBQUNjLGNBQVYsQ0FBeUJOLE1BQXpCLEVBQWlDZCxJQUFqQyxFQUF1Q0EsSUFBdkMsQ0FBWDtBQUNEOztBQUVELFFBQUlRLElBQUksQ0FBQ2lCLFVBQUwsRUFBSixFQUF1QjtBQUNyQlAsTUFBQUEsUUFBUSxHQUFHVixJQUFJLENBQUNVLFFBQUwsQ0FBY0EsUUFBZCxHQUNQVixJQUFJLENBQUNVLFFBQUwsQ0FBY0EsUUFBZCxDQUF1QlEsS0FBdkIsRUFETyxHQUVQbEIsSUFBSSxDQUFDVSxRQUFMLENBQWNRLEtBQWQsRUFGSjtBQUdEOztBQUVELFFBQUksQ0FBQ1IsUUFBTCxFQUFlO0FBQ2JBLE1BQUFBLFFBQVEsR0FBRyxJQUFJWixLQUFLLENBQUNpQixXQUFWLENBQXNCWixLQUF0QixFQUE2QkMsTUFBN0IsRUFBcUNDLEtBQXJDLENBQVg7QUFDRDs7QUFFRCxVQUFNYyxRQUFRLEdBQUcsSUFBSXJCLEtBQUssQ0FBQ3NCLGlCQUFWLENBQTRCO0FBQUVuQixNQUFBQSxLQUFGO0FBQVNDLE1BQUFBO0FBQVQsS0FBNUIsQ0FBakIsQ0F6Q3NELENBMEN0RDtBQUNBOztBQUNBLFVBQU1tQixJQUFJLEdBQUcsSUFBSXZCLEtBQUssQ0FBQ3dCLElBQVYsQ0FBZVosUUFBUSxDQUFDUSxLQUFULEVBQWYsRUFBaUNDLFFBQWpDLENBQWI7QUFFQXBCLElBQUFBLFNBQVMsQ0FBQ3dCLEdBQVYsQ0FBY0YsSUFBZDtBQUVBLFNBQUs1QixnQkFBTCxDQUFzQkMsTUFBdEIsRUFBOEIsWUFBVztBQUN2QzJCLE1BQUFBLElBQUksQ0FBQ0csUUFBTCxDQUFjQyxHQUFkLENBQWtCbEIsQ0FBbEIsRUFBcUJDLENBQXJCLEVBQXdCQyxDQUF4QjtBQUNELEtBRkQ7QUFHRCxHQXpFWTs7QUEyRWI7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0VpQixFQUFBQSxXQUFXLEVBQUUsVUFBUzVCLEtBQVQsRUFBZ0JKLE1BQWhCLEVBQXdCSyxTQUF4QixFQUFtQzRCLE9BQW5DLEVBQTRDMUIsS0FBNUMsRUFBbUQ7QUFDOUQsVUFBTVMsUUFBUSxHQUFHLElBQUlaLEtBQUssQ0FBQzhCLGtCQUFWLENBQTZCcEMsSUFBN0IsQ0FBakI7QUFDQSxVQUFNMkIsUUFBUSxHQUFHLElBQUlyQixLQUFLLENBQUNzQixpQkFBVixDQUE0QjtBQUMzQ25CLE1BQUFBLEtBQUssRUFBRUEsS0FBSyxJQUFJLE1BRDJCO0FBRTNDQyxNQUFBQSxTQUFTLEVBQUU7QUFGZ0MsS0FBNUIsQ0FBakIsQ0FGOEQsQ0FNOUQ7QUFDQTs7QUFDQSxVQUFNbUIsSUFBSSxHQUFHLElBQUl2QixLQUFLLENBQUN3QixJQUFWLENBQWVaLFFBQVEsQ0FBQ1EsS0FBVCxFQUFmLEVBQWlDQyxRQUFqQyxDQUFiO0FBRUFwQixJQUFBQSxTQUFTLENBQUN3QixHQUFWLENBQWNGLElBQWQ7QUFFQSxTQUFLNUIsZ0JBQUwsQ0FBc0JDLE1BQXRCLEVBQThCLFlBQVc7QUFDdkMyQixNQUFBQSxJQUFJLENBQUNHLFFBQUwsQ0FBY0ssSUFBZCxDQUFtQkYsT0FBTyxDQUFDSCxRQUEzQjtBQUNBSCxNQUFBQSxJQUFJLENBQUNTLFFBQUwsQ0FBY0wsR0FBZCxDQUNFRSxPQUFPLENBQUNHLFFBQVIsQ0FBaUJ2QixDQURuQixFQUVFb0IsT0FBTyxDQUFDRyxRQUFSLENBQWlCdEIsQ0FGbkIsRUFHRW1CLE9BQU8sQ0FBQ0csUUFBUixDQUFpQnJCLENBSG5CO0FBS0QsS0FQRDtBQVFELEdBeEdZOztBQTBHYjtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNFc0IsRUFBQUEsVUFBVSxFQUFHLFlBQVc7QUFDdEIsYUFBU0MsZ0JBQVQsQ0FBMEJDLElBQTFCLEVBQWdDdkMsTUFBaEMsRUFBd0M7QUFDdEMsVUFBSXdDLElBQUksR0FBR0QsSUFBSSxJQUFJLFVBQVIsR0FBcUIsZUFBckIsR0FBdUMsYUFBbEQ7QUFDQSxVQUFJRSxRQUFRLEdBQUd6QyxNQUFNLENBQUMwQyxTQUFQLENBQWlCLENBQWpCLENBQWY7QUFFQSxhQUFPRCxRQUFRLENBQUNELElBQUQsQ0FBUixDQUFlRyxHQUF0QjtBQUNEOztBQUVELGFBQVNDLGFBQVQsQ0FBdUI1QyxNQUF2QixFQUErQjtBQUM3QixVQUFJNkMsQ0FBQyxHQUFHN0MsTUFBTSxDQUFDOEMsUUFBUCxDQUFnQixDQUFoQixDQUFSO0FBRUEsYUFDRUMsSUFBSSxDQUFDQyxLQUFMLENBQVdILENBQUMsQ0FBQ0ksQ0FBRixDQUFJcEMsQ0FBZixJQUFvQixHQUFwQixHQUEwQmtDLElBQUksQ0FBQ0MsS0FBTCxDQUFXSCxDQUFDLENBQUNJLENBQUYsQ0FBSW5DLENBQWYsQ0FBMUIsR0FBOEMsR0FBOUMsR0FBb0RpQyxJQUFJLENBQUNDLEtBQUwsQ0FBV0gsQ0FBQyxDQUFDSSxDQUFGLENBQUlsQyxDQUFmLENBRHREO0FBR0Q7O0FBRUQsV0FBTyxVQUFTZixNQUFULEVBQWlCa0QsS0FBakIsRUFBd0I7QUFDN0IsV0FBS0MsT0FBTCxDQUFhRCxLQUFiO0FBQ0EsVUFBSUUsR0FBRyxHQUFHLEVBQVY7O0FBRUEsY0FBUSxLQUFLQyxTQUFiO0FBQ0UsYUFBSyxDQUFMO0FBQ0VELFVBQUFBLEdBQUcsSUFBSSxhQUFhcEQsTUFBTSxDQUFDOEMsUUFBUCxDQUFnQlEsTUFBN0IsR0FBc0MsTUFBN0M7QUFDQUYsVUFBQUEsR0FBRyxJQUFJLGNBQWNwRCxNQUFNLENBQUM4QyxRQUFQLENBQWdCLENBQWhCLEVBQW1CSCxHQUFqQyxHQUF1QyxNQUE5QztBQUNBUyxVQUFBQSxHQUFHLElBQUksU0FBU1IsYUFBYSxDQUFDNUMsTUFBRCxDQUE3QjtBQUNBOztBQUVGLGFBQUssQ0FBTDtBQUNFb0QsVUFBQUEsR0FBRyxJQUFJcEQsTUFBTSxDQUFDMEMsU0FBUCxDQUFpQixDQUFqQixFQUFvQmEsSUFBcEIsR0FBMkIsTUFBbEM7QUFDQUgsVUFBQUEsR0FBRyxJQUFJLFlBQVlkLGdCQUFnQixDQUFDLFFBQUQsQ0FBNUIsR0FBeUMsTUFBaEQ7QUFDQWMsVUFBQUEsR0FBRyxJQUFJLGNBQWNkLGdCQUFnQixDQUFDLFVBQUQsQ0FBckM7QUFDQTs7QUFFRjtBQUNFYyxVQUFBQSxHQUFHLElBQUksZUFBZXBELE1BQU0sQ0FBQ3dELFFBQVAsRUFBZixHQUFtQyxNQUExQztBQUNBSixVQUFBQSxHQUFHLElBQUksVUFBVXBELE1BQU0sQ0FBQ3dDLElBQVAsQ0FBWWdCLFFBQVosRUFBVixHQUFtQyxNQUExQztBQUNBSixVQUFBQSxHQUFHLElBQUksWUFBWXBELE1BQU0sQ0FBQ3dELFFBQVAsS0FBb0J4RCxNQUFNLENBQUN3QyxJQUFQLENBQVlnQixRQUFaLEVBQWhDLENBQVA7QUFoQko7O0FBa0JBLFdBQUtDLFFBQUwsQ0FBY0MsU0FBZCxHQUEwQk4sR0FBMUI7QUFDRCxLQXZCRDtBQXdCRCxHQXhDVyxFQWpIQzs7QUEySmI7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0VELEVBQUFBLE9BQU8sRUFBRyxZQUFXO0FBQ25CLFdBQU8sVUFBU0QsS0FBVCxFQUFnQjtBQUNyQixVQUFJUyxJQUFJLEdBQUcsSUFBWDs7QUFFQSxVQUFJLENBQUMsS0FBS0YsUUFBVixFQUFvQjtBQUNsQixhQUFLQSxRQUFMLEdBQWdCRyxRQUFRLENBQUNDLGFBQVQsQ0FBdUIsS0FBdkIsQ0FBaEI7QUFDQSxhQUFLSixRQUFMLENBQWNQLEtBQWQsQ0FBb0JZLE9BQXBCLEdBQThCLENBQzVCLGtEQUQ0QixFQUU1Qix3REFGNEIsRUFHNUIsMkRBSDRCLEVBSTVCQyxJQUo0QixDQUl2QixFQUp1QixDQUE5QjtBQU1BLGFBQUtWLFNBQUwsR0FBaUIsQ0FBakI7O0FBQ0EsYUFBS0ksUUFBTCxDQUFjMUQsZ0JBQWQsQ0FDRSxPQURGLEVBRUUsWUFBVztBQUNUNEQsVUFBQUEsSUFBSSxDQUFDTixTQUFMO0FBQ0EsY0FBSU0sSUFBSSxDQUFDTixTQUFMLEdBQWlCLENBQXJCLEVBQXdCTSxJQUFJLENBQUNOLFNBQUwsR0FBaUIsQ0FBakI7QUFDekIsU0FMSCxFQU1FLEtBTkY7O0FBU0EsWUFBSVcsRUFBSixFQUFRekQsS0FBUjs7QUFFQSxnQkFBUTJDLEtBQVI7QUFDRSxlQUFLLENBQUw7QUFDRWMsWUFBQUEsRUFBRSxHQUFHLE1BQUw7QUFDQXpELFlBQUFBLEtBQUssR0FBRyxNQUFSO0FBQ0E7O0FBRUYsZUFBSyxDQUFMO0FBQ0V5RCxZQUFBQSxFQUFFLEdBQUcsTUFBTDtBQUNBekQsWUFBQUEsS0FBSyxHQUFHLE1BQVI7QUFDQTs7QUFFRjtBQUNFeUQsWUFBQUEsRUFBRSxHQUFHLE1BQUw7QUFDQXpELFlBQUFBLEtBQUssR0FBRyxNQUFSO0FBYko7O0FBZ0JBLGFBQUtrRCxRQUFMLENBQWNQLEtBQWQsQ0FBb0Isa0JBQXBCLElBQTBDYyxFQUExQztBQUNBLGFBQUtQLFFBQUwsQ0FBY1AsS0FBZCxDQUFvQixPQUFwQixJQUErQjNDLEtBQS9CO0FBQ0Q7O0FBRUQsVUFBSSxDQUFDLEtBQUtrRCxRQUFMLENBQWNRLFVBQW5CLEVBQStCTCxRQUFRLENBQUNNLElBQVQsQ0FBY0MsV0FBZCxDQUEwQixLQUFLVixRQUEvQjtBQUNoQyxLQTVDRDtBQTZDRCxHQTlDUTtBQWpLSSxDQUFmIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgREVGQVVMVF9QT1NJVElPTiwgREVGQVVMVF9TSVpFIGFzIHNpemUgfSBmcm9tICcuL2NvbnN0YW50cyc7XHJcblxyXG4vKipcclxuICogQGV4cG9ydHMgRGVidWcgLSBtZXRob2RzIGFuZCBoZWxwZXJzIGZvciBkZWJ1Z2dpbmcgU3lzdGVtIGVtaXR0ZXJzLCB6b25lcyBhbmQgcGFydGljbGVzLlxyXG4gKiBAcmVxdWlyZXMgVEhSRUUgLSB7IFNwaGVyZUdlb21ldHJ5LCBCb3hHZW9tZXRyeSwgTWVzaEJhc2ljTWF0ZXJpYWwsIE9jdGFoZWRyb25HZW9tZXRyeSwgTWVzaCB9XHJcbiAqL1xyXG5leHBvcnQgZGVmYXVsdCB7XHJcbiAgLyoqXHJcbiAgICogQWRkcyBhbiBldmVudCBsaXN0ZW5lciB0byB0aGUgc3lzdGVtIGluc3RhbmNlJ3MgU1lTVEVNX1VQREFURSBldmVudC5cclxuICAgKlxyXG4gICAqIEBwYXJhbSB7U3lzdGVtfSBzeXN0ZW0gLSB0aGUgc3lzdGVtIGluc3RhbmNlXHJcbiAgICogQHBhcmFtIHtmdW5jdGlvbn0gb25TeXN0ZW1VcGRhdGVkIC0gdGhlIGZ1bmN0aW9uIHRvIGNhbGwgd2hlbiBzeXN0ZW0gaGFzIGJlZW4gdXBkYXRlZFxyXG4gICAqIEByZXR1cm4ge0RlYnVnfVxyXG4gICAqL1xyXG4gIGFkZEV2ZW50TGlzdGVuZXI6IGZ1bmN0aW9uKHN5c3RlbSwgb25TeXN0ZW1VcGRhdGVkKSB7XHJcbiAgICBzeXN0ZW0uZXZlbnREaXNwYXRjaGVyLmFkZEV2ZW50TGlzdGVuZXIoJ1NZU1RFTV9VUERBVEUnLCBvblN5c3RlbVVwZGF0ZWQpO1xyXG5cclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH0sXHJcblxyXG4gIC8qKlxyXG4gICAqIERyYXdzIGEgd2lyZWZyYW1lIG1lc2ggYXJvdW5kIHRoZSB6b25lIGZvciBkZWJ1Z2dpbmcgcHVycG9zZXMuXHJcbiAgICpcclxuICAgKiBAcGFyYW0ge1N5c3RlbX0gc3lzdGVtIC0gdGhlIHN5c3RlbSBpbnN0YW5jZVxyXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBjb250YWluZXIgLSBhIHRocmVlIE9iamVjdDNEICh1c3VhbGx5IHRoZSBzY2VuZSlcclxuICAgKiBAcGFyYW0ge1pvbmV9IHpvbmUgLSBhIFpvbmUgaW5zdGFuY2VcclxuICAgKiBAcmV0dXJuIHZvaWRcclxuICAgKi9cclxuICBkcmF3Wm9uZTogZnVuY3Rpb24oVEhSRUUsIHN5c3RlbSwgY29udGFpbmVyLCB6b25lID0ge30pIHtcclxuICAgIGNvbnN0IGNvbG9yID0gJyMyMTk0Y2UnO1xyXG4gICAgY29uc3Qgd2lyZWZyYW1lID0gdHJ1ZTtcclxuICAgIGNvbnN0IHtcclxuICAgICAgd2lkdGggPSBzaXplLFxyXG4gICAgICBoZWlnaHQgPSBzaXplLFxyXG4gICAgICBkZXB0aCA9IHNpemUsXHJcbiAgICAgIHJhZGl1cyA9IHNpemUsXHJcbiAgICAgIHggPSBERUZBVUxUX1BPU0lUSU9OLFxyXG4gICAgICB5ID0gREVGQVVMVF9QT1NJVElPTixcclxuICAgICAgeiA9IERFRkFVTFRfUE9TSVRJT04sXHJcbiAgICB9ID0gem9uZTtcclxuXHJcbiAgICBsZXQgZ2VvbWV0cnk7XHJcblxyXG4gICAgaWYgKHpvbmUuaXNQb2ludFpvbmUoKSkge1xyXG4gICAgICBnZW9tZXRyeSA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeSgxNSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHpvbmUuaXNMaW5lWm9uZSgpKSB7XHJcbiAgICAgIC8vIFRPRE9cclxuICAgIH1cclxuXHJcbiAgICBpZiAoem9uZS5pc0JveFpvbmUoKSkge1xyXG4gICAgICBnZW9tZXRyeSA9IG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSh3aWR0aCwgaGVpZ2h0LCBkZXB0aCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHpvbmUuaXNTcGhlcmVab25lKCkpIHtcclxuICAgICAgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuU3BoZXJlR2VvbWV0cnkocmFkaXVzLCBzaXplLCBzaXplKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoem9uZS5pc01lc2hab25lKCkpIHtcclxuICAgICAgZ2VvbWV0cnkgPSB6b25lLmdlb21ldHJ5Lmdlb21ldHJ5XHJcbiAgICAgICAgPyB6b25lLmdlb21ldHJ5Lmdlb21ldHJ5LmNsb25lKClcclxuICAgICAgICA6IHpvbmUuZ2VvbWV0cnkuY2xvbmUoKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIWdlb21ldHJ5KSB7XHJcbiAgICAgIGdlb21ldHJ5ID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KHdpZHRoLCBoZWlnaHQsIGRlcHRoKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yLCB3aXJlZnJhbWUgfSk7XHJcbiAgICAvLyBOT1RFISBnZW9tZXRyeS5jbG9uZSBpcyByZXF1aXJlZCBmb3IgVU5LTk9XTiByZWFzb25zLFxyXG4gICAgLy8gdGhyZWUgZG9lcyBub3QgcmVuZGVyIHRoZSBtZXNoIGNvcnJlY3RseSB3aXRob3V0IGRvaW5nIHRoaXMgc2luY2Ugcjg4XHJcbiAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnkuY2xvbmUoKSwgbWF0ZXJpYWwpO1xyXG5cclxuICAgIGNvbnRhaW5lci5hZGQobWVzaCk7XHJcblxyXG4gICAgdGhpcy5hZGRFdmVudExpc3RlbmVyKHN5c3RlbSwgZnVuY3Rpb24oKSB7XHJcbiAgICAgIG1lc2gucG9zaXRpb24uc2V0KHgsIHksIHopO1xyXG4gICAgfSk7XHJcbiAgfSxcclxuXHJcbiAgLyoqXHJcbiAgICogRHJhd3MgYSBtZXNoIGZvciBlYWNoIHBhcnRpY2xlIGVtaXR0ZWQgaW4gb3JkZXIgdG8gaGVscCBkZWJ1ZyBwYXJ0aWNsZXMuXHJcbiAgICpcclxuICAgKiBAcGFyYW0ge29iamVjdH0gc3lzdGVtIC0gdGhlIHN5c3RlbSBpbnN0YW5jZVxyXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBjb250YWluZXIgLSBhIHRocmVlIE9iamVjdDNEICh1c3VhbGx5IHRoZSBzY2VuZSlcclxuICAgKiBAcGFyYW0ge29iamVjdH0gZW1pdHRlciAtIHRoZSBlbWl0dGVyIHRvIGRlYnVnXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNvbG9yIC0gdGhlIGNvbG9yIGZvciB0aGUgZGVidWcgbWVzaCBtYXRlcmlhbFxyXG4gICAqIEByZXR1cm4gdm9pZFxyXG4gICAqL1xyXG4gIGRyYXdFbWl0dGVyOiBmdW5jdGlvbihUSFJFRSwgc3lzdGVtLCBjb250YWluZXIsIGVtaXR0ZXIsIGNvbG9yKSB7XHJcbiAgICBjb25zdCBnZW9tZXRyeSA9IG5ldyBUSFJFRS5PY3RhaGVkcm9uR2VvbWV0cnkoc2l6ZSk7XHJcbiAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7XHJcbiAgICAgIGNvbG9yOiBjb2xvciB8fCAnI2FhYScsXHJcbiAgICAgIHdpcmVmcmFtZTogdHJ1ZSxcclxuICAgIH0pO1xyXG4gICAgLy8gTk9URSEgZ2VvbWV0cnkuY2xvbmUgaXMgcmVxdWlyZWQgZm9yIFVOS05PV04gcmVhc29ucyxcclxuICAgIC8vIHRocmVlIGRvZXMgbm90IHJlbmRlciB0aGUgbWVzaCBjb3JyZWN0bHkgd2l0aG91dCBkb2luZyB0aGlzIHNpbmNlIHI4OFxyXG4gICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LmNsb25lKCksIG1hdGVyaWFsKTtcclxuXHJcbiAgICBjb250YWluZXIuYWRkKG1lc2gpO1xyXG5cclxuICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcihzeXN0ZW0sIGZ1bmN0aW9uKCkge1xyXG4gICAgICBtZXNoLnBvc2l0aW9uLmNvcHkoZW1pdHRlci5wb3NpdGlvbik7XHJcbiAgICAgIG1lc2gucm90YXRpb24uc2V0KFxyXG4gICAgICAgIGVtaXR0ZXIucm90YXRpb24ueCxcclxuICAgICAgICBlbWl0dGVyLnJvdGF0aW9uLnksXHJcbiAgICAgICAgZW1pdHRlci5yb3RhdGlvbi56XHJcbiAgICAgICk7XHJcbiAgICB9KTtcclxuICB9LFxyXG5cclxuICAvKipcclxuICAgKiBSZW5kZXJzIGVtaXR0ZXIgLyBwYXJ0aWNsZSBpbmZvcm1hdGlvbiBpbnRvIHRoZSBpbmZvIGVsZW1lbnQuXHJcbiAgICpcclxuICAgKiBAcGFyYW0ge29iamVjdH0gc3lzdGVtIC0gdGhlIHN5c3RlbSBpbnN0YW5jZVxyXG4gICAqIEBwYXJhbSB7aW50ZWdlcn0gc3R5bGUgLSBzdHlsZSB0byBhcHBseSAoc2VlIHRoZSBhZGRJbmZvIG1ldGhvZCdzIHN3aXRjaCBzdGF0ZW1lbnQpXHJcbiAgICogQHJldHVybiB2b2lkXHJcbiAgICovXHJcbiAgcmVuZGVySW5mbzogKGZ1bmN0aW9uKCkge1xyXG4gICAgZnVuY3Rpb24gZ2V0Q3JlYXRlZE51bWJlcih0eXBlLCBzeXN0ZW0pIHtcclxuICAgICAgdmFyIHBvb2wgPSB0eXBlID09ICdtYXRlcmlhbCcgPyAnX21hdGVyaWFsUG9vbCcgOiAnX3RhcmdldFBvb2wnO1xyXG4gICAgICB2YXIgcmVuZGVyZXIgPSBzeXN0ZW0ucmVuZGVyZXJzWzBdO1xyXG5cclxuICAgICAgcmV0dXJuIHJlbmRlcmVyW3Bvb2xdLmNJRDtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBnZXRFbWl0dGVyUG9zKHN5c3RlbSkge1xyXG4gICAgICB2YXIgZSA9IHN5c3RlbS5lbWl0dGVyc1swXTtcclxuXHJcbiAgICAgIHJldHVybiAoXHJcbiAgICAgICAgTWF0aC5yb3VuZChlLnAueCkgKyAnLCcgKyBNYXRoLnJvdW5kKGUucC55KSArICcsJyArIE1hdGgucm91bmQoZS5wLnopXHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGZ1bmN0aW9uKHN5c3RlbSwgc3R5bGUpIHtcclxuICAgICAgdGhpcy5hZGRJbmZvKHN0eWxlKTtcclxuICAgICAgdmFyIHN0ciA9ICcnO1xyXG5cclxuICAgICAgc3dpdGNoICh0aGlzLl9pbmZvVHlwZSkge1xyXG4gICAgICAgIGNhc2UgMjpcclxuICAgICAgICAgIHN0ciArPSAnZW1pdHRlcjonICsgc3lzdGVtLmVtaXR0ZXJzLmxlbmd0aCArICc8YnI+JztcclxuICAgICAgICAgIHN0ciArPSAnZW0gc3BlZWQ6JyArIHN5c3RlbS5lbWl0dGVyc1swXS5jSUQgKyAnPGJyPic7XHJcbiAgICAgICAgICBzdHIgKz0gJ3BvczonICsgZ2V0RW1pdHRlclBvcyhzeXN0ZW0pO1xyXG4gICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgIGNhc2UgMzpcclxuICAgICAgICAgIHN0ciArPSBzeXN0ZW0ucmVuZGVyZXJzWzBdLm5hbWUgKyAnPGJyPic7XHJcbiAgICAgICAgICBzdHIgKz0gJ3RhcmdldDonICsgZ2V0Q3JlYXRlZE51bWJlcigndGFyZ2V0JykgKyAnPGJyPic7XHJcbiAgICAgICAgICBzdHIgKz0gJ21hdGVyaWFsOicgKyBnZXRDcmVhdGVkTnVtYmVyKCdtYXRlcmlhbCcpO1xyXG4gICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICBzdHIgKz0gJ3BhcnRpY2xlczonICsgc3lzdGVtLmdldENvdW50KCkgKyAnPGJyPic7XHJcbiAgICAgICAgICBzdHIgKz0gJ3Bvb2w6JyArIHN5c3RlbS5wb29sLmdldENvdW50KCkgKyAnPGJyPic7XHJcbiAgICAgICAgICBzdHIgKz0gJ3RvdGFsOicgKyAoc3lzdGVtLmdldENvdW50KCkgKyBzeXN0ZW0ucG9vbC5nZXRDb3VudCgpKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLl9pbmZvQ29uLmlubmVySFRNTCA9IHN0cjtcclxuICAgIH07XHJcbiAgfSkoKSxcclxuXHJcbiAgLyoqXHJcbiAgICogQXBwZW5kcyB0aGUgaW5mbyBlbGVtZW50IGludG8gdGhlIGRvbS5cclxuICAgKlxyXG4gICAqIEBwYXJhbSB7aW50ZWdlcn0gc3R5bGUgLSB0aGUgc3R5bGUgdHlwZSB0byBhcHBseVxyXG4gICAqIEByZXR1cm4gdm9pZFxyXG4gICAqL1xyXG4gIGFkZEluZm86IChmdW5jdGlvbigpIHtcclxuICAgIHJldHVybiBmdW5jdGlvbihzdHlsZSkge1xyXG4gICAgICB2YXIgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgICBpZiAoIXRoaXMuX2luZm9Db24pIHtcclxuICAgICAgICB0aGlzLl9pbmZvQ29uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgdGhpcy5faW5mb0Nvbi5zdHlsZS5jc3NUZXh0ID0gW1xyXG4gICAgICAgICAgJ3Bvc2l0aW9uOmZpeGVkO2JvdHRvbTowcHg7bGVmdDowO2N1cnNvcjpwb2ludGVyOycsXHJcbiAgICAgICAgICAnb3BhY2l0eTowLjk7ei1pbmRleDoxMDAwMDtwYWRkaW5nOjEwcHg7Zm9udC1zaXplOjEycHg7JyxcclxuICAgICAgICAgICd3aWR0aDoxMjBweDtoZWlnaHQ6NTBweDtiYWNrZ3JvdW5kLWNvbG9yOiMwMDI7Y29sb3I6IzBmZjsnLFxyXG4gICAgICAgIF0uam9pbignJyk7XHJcblxyXG4gICAgICAgIHRoaXMuX2luZm9UeXBlID0gMTtcclxuICAgICAgICB0aGlzLl9pbmZvQ29uLmFkZEV2ZW50TGlzdGVuZXIoXHJcbiAgICAgICAgICAnY2xpY2snLFxyXG4gICAgICAgICAgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIHNlbGYuX2luZm9UeXBlKys7XHJcbiAgICAgICAgICAgIGlmIChzZWxmLl9pbmZvVHlwZSA+IDMpIHNlbGYuX2luZm9UeXBlID0gMTtcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBmYWxzZVxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIHZhciBiZywgY29sb3I7XHJcblxyXG4gICAgICAgIHN3aXRjaCAoc3R5bGUpIHtcclxuICAgICAgICAgIGNhc2UgMjpcclxuICAgICAgICAgICAgYmcgPSAnIzIwMSc7XHJcbiAgICAgICAgICAgIGNvbG9yID0gJyNmMDgnO1xyXG4gICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICBjYXNlIDM6XHJcbiAgICAgICAgICAgIGJnID0gJyMwMjAnO1xyXG4gICAgICAgICAgICBjb2xvciA9ICcjMGYwJztcclxuICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgYmcgPSAnIzAwMic7XHJcbiAgICAgICAgICAgIGNvbG9yID0gJyMwZmYnO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5faW5mb0Nvbi5zdHlsZVsnYmFja2dyb3VuZC1jb2xvciddID0gYmc7XHJcbiAgICAgICAgdGhpcy5faW5mb0Nvbi5zdHlsZVsnY29sb3InXSA9IGNvbG9yO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoIXRoaXMuX2luZm9Db24ucGFyZW50Tm9kZSkgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLl9pbmZvQ29uKTtcclxuICAgIH07XHJcbiAgfSkoKSxcclxufTtcclxuIl19