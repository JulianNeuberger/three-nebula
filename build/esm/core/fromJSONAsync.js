import _defineProperty from "@babel/runtime/helpers/defineProperty";

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

import * as Behaviour from '../behaviour';
import * as Initializer from '../initializer';
import { EULER, POOL_MAX } from '../constants';
import { INITIALIZER_TYPES_THAT_REQUIRE_THREE, SUPPORTED_JSON_BEHAVIOUR_TYPES, SUPPORTED_JSON_INITIALIZER_TYPES } from './constants';
import Rate from '../initializer/Rate';
import TextureInitializer from '../initializer/Texture';
const DEFAULT_OPTIONS = {
  shouldAutoEmit: true
};
/**
 * Makes a rate instance.
 *
 * @param {object} json - The data required to construct a Rate instance
 * @return {Rate}
 */

const makeRate = json => Rate.fromJSON(json);
/**
 * Makes initializers from json items.
 *
 * @param {array<object>} items - An array of objects which provide initializer constructor params
 * @param {object} THREE - The Web GL Api to use
 * @return {array<Initializer>}
 */


const makeInitializers = (items, THREE) => new Promise((resolve, reject) => {
  if (!items.length) {
    return resolve([]);
  }

  const numberOfInitializers = items.length;
  const madeInitializers = [];
  const doNotRequireTextureLoading = items.filter(({
    properties
  }) => !properties.texture);
  const doRequireTextureLoading = items.filter(({
    properties
  }) => properties.texture);
  doNotRequireTextureLoading.forEach(data => {
    const {
      type,
      properties
    } = data;

    if (!SUPPORTED_JSON_INITIALIZER_TYPES.includes(type)) {
      return reject(`The initializer type ${type} is invalid or not yet supported`);
    }

    if (INITIALIZER_TYPES_THAT_REQUIRE_THREE.includes(type)) {
      madeInitializers.push(Initializer[type].fromJSON(properties, THREE));
    } else {
      madeInitializers.push(Initializer[type].fromJSON(properties));
    }

    if (madeInitializers.length === numberOfInitializers) {
      return resolve(madeInitializers);
    }
  });
  doRequireTextureLoading.forEach(data => {
    const {
      type,
      properties,
      properties: {
        texture
      }
    } = data;
    const textureLoader = new THREE.TextureLoader();

    if (!SUPPORTED_JSON_INITIALIZER_TYPES.includes(type)) {
      return reject(`The initializer type ${type} is invalid or not yet supported`);
    }

    textureLoader.load(texture, loadedTexture => {
      madeInitializers.push(TextureInitializer.fromJSON(_objectSpread(_objectSpread({}, properties), {}, {
        loadedTexture
      }), THREE));

      if (madeInitializers.length === numberOfInitializers) {
        return resolve(madeInitializers);
      }
    }, undefined, reject);
  });
});
/**
 * Makes behaviours from json items.
 *
 * @param {array<object>} items - An array of objects which provide behaviour constructor params
 * @return {Promise<array>}
 */


const makeBehaviours = items => new Promise((resolve, reject) => {
  if (!items.length) {
    return resolve([]);
  }

  const numberOfBehaviours = items.length;
  const madeBehaviours = [];
  items.forEach(data => {
    const {
      type,
      properties
    } = data;

    if (!SUPPORTED_JSON_BEHAVIOUR_TYPES.includes(type)) {
      return reject(`The behaviour type ${type} is invalid or not yet supported`);
    }

    madeBehaviours.push(Behaviour[type].fromJSON(properties));

    if (madeBehaviours.length === numberOfBehaviours) {
      return resolve(madeBehaviours);
    }
  });
});

const makeEmitters = (emitters, Emitter, THREE, shouldAutoEmit) => new Promise((resolve, reject) => {
  if (!emitters.length) {
    return resolve([]);
  }

  const madeEmitters = [];
  const numberOfEmitters = emitters.length;

  if (!numberOfEmitters) {
    return resolve(madeEmitters);
  }

  emitters.forEach(data => {
    const emitter = new Emitter();
    const {
      rate,
      rotation,
      initializers,
      behaviours,
      emitterBehaviours = [],
      position,
      totalEmitTimes = Infinity,
      life = Infinity
    } = data;
    emitter.setRate(makeRate(rate)).setRotation(rotation).setPosition(position);
    makeInitializers(initializers, THREE).then(madeInitializers => {
      emitter.setInitializers(madeInitializers);
      return makeBehaviours(behaviours);
    }).then(madeBehaviours => {
      emitter.setBehaviours(madeBehaviours);
      return makeBehaviours(emitterBehaviours);
    }).then(madeEmitterBehaviours => {
      emitter.setEmitterBehaviours(madeEmitterBehaviours);
      return Promise.resolve(emitter);
    }).then(emitter => {
      madeEmitters.push(shouldAutoEmit ? emitter.emit(totalEmitTimes, life) : emitter.setTotalEmitTimes(totalEmitTimes).setLife(life));

      if (madeEmitters.length === numberOfEmitters) {
        return resolve(madeEmitters);
      }
    }).catch(reject);
  });
});
/**
 * Creates a System instance from a JSON object.
 *
 * @param {object} json - The JSON to create the System instance from
 * @param {number} json.preParticles - The predetermined number of particles
 * @param {string} json.integrationType - The integration algorithm to use
 * @param {array<object>} json.emitters - The emitters for the system instance
 * @param {object} THREE - The Web GL Api to use
 * @param {function} System - The system class
 * @param {function} Emitter - The emitter class
 * @param {object} [options={}] - Optional config options
 * @return {Promise<System>}
 */


export default ((json, THREE, System, Emitter, options = {}) => new Promise((resolve, reject) => {
  const {
    preParticles = POOL_MAX,
    integrationType = EULER,
    emitters = []
  } = json;
  const system = new System(preParticles, integrationType);

  const {
    shouldAutoEmit
  } = _objectSpread(_objectSpread({}, DEFAULT_OPTIONS), options);

  makeEmitters(emitters, Emitter, THREE, shouldAutoEmit).then(madeEmitters => {
    const numberOfEmitters = madeEmitters.length;

    if (!numberOfEmitters) {
      return resolve(system);
    }

    madeEmitters.forEach(madeEmitter => {
      system.addEmitter(madeEmitter);

      if (system.emitters.length === numberOfEmitters) {
        resolve(system);
      }
    });
  }).catch(reject);
}));
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb3JlL2Zyb21KU09OQXN5bmMuanMiXSwibmFtZXMiOlsiQmVoYXZpb3VyIiwiSW5pdGlhbGl6ZXIiLCJFVUxFUiIsIlBPT0xfTUFYIiwiSU5JVElBTElaRVJfVFlQRVNfVEhBVF9SRVFVSVJFX1RIUkVFIiwiU1VQUE9SVEVEX0pTT05fQkVIQVZJT1VSX1RZUEVTIiwiU1VQUE9SVEVEX0pTT05fSU5JVElBTElaRVJfVFlQRVMiLCJSYXRlIiwiVGV4dHVyZUluaXRpYWxpemVyIiwiREVGQVVMVF9PUFRJT05TIiwic2hvdWxkQXV0b0VtaXQiLCJtYWtlUmF0ZSIsImpzb24iLCJmcm9tSlNPTiIsIm1ha2VJbml0aWFsaXplcnMiLCJpdGVtcyIsIlRIUkVFIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJsZW5ndGgiLCJudW1iZXJPZkluaXRpYWxpemVycyIsIm1hZGVJbml0aWFsaXplcnMiLCJkb05vdFJlcXVpcmVUZXh0dXJlTG9hZGluZyIsImZpbHRlciIsInByb3BlcnRpZXMiLCJ0ZXh0dXJlIiwiZG9SZXF1aXJlVGV4dHVyZUxvYWRpbmciLCJmb3JFYWNoIiwiZGF0YSIsInR5cGUiLCJpbmNsdWRlcyIsInB1c2giLCJ0ZXh0dXJlTG9hZGVyIiwiVGV4dHVyZUxvYWRlciIsImxvYWQiLCJsb2FkZWRUZXh0dXJlIiwidW5kZWZpbmVkIiwibWFrZUJlaGF2aW91cnMiLCJudW1iZXJPZkJlaGF2aW91cnMiLCJtYWRlQmVoYXZpb3VycyIsIm1ha2VFbWl0dGVycyIsImVtaXR0ZXJzIiwiRW1pdHRlciIsIm1hZGVFbWl0dGVycyIsIm51bWJlck9mRW1pdHRlcnMiLCJlbWl0dGVyIiwicmF0ZSIsInJvdGF0aW9uIiwiaW5pdGlhbGl6ZXJzIiwiYmVoYXZpb3VycyIsImVtaXR0ZXJCZWhhdmlvdXJzIiwicG9zaXRpb24iLCJ0b3RhbEVtaXRUaW1lcyIsIkluZmluaXR5IiwibGlmZSIsInNldFJhdGUiLCJzZXRSb3RhdGlvbiIsInNldFBvc2l0aW9uIiwidGhlbiIsInNldEluaXRpYWxpemVycyIsInNldEJlaGF2aW91cnMiLCJtYWRlRW1pdHRlckJlaGF2aW91cnMiLCJzZXRFbWl0dGVyQmVoYXZpb3VycyIsImVtaXQiLCJzZXRUb3RhbEVtaXRUaW1lcyIsInNldExpZmUiLCJjYXRjaCIsIlN5c3RlbSIsIm9wdGlvbnMiLCJwcmVQYXJ0aWNsZXMiLCJpbnRlZ3JhdGlvblR5cGUiLCJzeXN0ZW0iLCJtYWRlRW1pdHRlciIsImFkZEVtaXR0ZXIiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLE9BQU8sS0FBS0EsU0FBWixNQUEyQixjQUEzQjtBQUNBLE9BQU8sS0FBS0MsV0FBWixNQUE2QixnQkFBN0I7QUFFQSxTQUFTQyxLQUFULEVBQWdCQyxRQUFoQixRQUFnQyxjQUFoQztBQUNBLFNBQ0VDLG9DQURGLEVBRUVDLDhCQUZGLEVBR0VDLGdDQUhGLFFBSU8sYUFKUDtBQU1BLE9BQU9DLElBQVAsTUFBaUIscUJBQWpCO0FBQ0EsT0FBT0Msa0JBQVAsTUFBK0Isd0JBQS9CO0FBRUEsTUFBTUMsZUFBZSxHQUFHO0FBQUVDLEVBQUFBLGNBQWMsRUFBRTtBQUFsQixDQUF4QjtBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFDQSxNQUFNQyxRQUFRLEdBQUdDLElBQUksSUFBSUwsSUFBSSxDQUFDTSxRQUFMLENBQWNELElBQWQsQ0FBekI7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0EsTUFBTUUsZ0JBQWdCLEdBQUcsQ0FBQ0MsS0FBRCxFQUFRQyxLQUFSLEtBQ3ZCLElBQUlDLE9BQUosQ0FBWSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDL0IsTUFBSSxDQUFDSixLQUFLLENBQUNLLE1BQVgsRUFBbUI7QUFDakIsV0FBT0YsT0FBTyxDQUFDLEVBQUQsQ0FBZDtBQUNEOztBQUVELFFBQU1HLG9CQUFvQixHQUFHTixLQUFLLENBQUNLLE1BQW5DO0FBQ0EsUUFBTUUsZ0JBQWdCLEdBQUcsRUFBekI7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TUFoQlQ7QUFpQkQsQ0ExQkQsQ0FERiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIEJlaGF2aW91ciBmcm9tICcuLi9iZWhhdmlvdXInO1xyXG5pbXBvcnQgKiBhcyBJbml0aWFsaXplciBmcm9tICcuLi9pbml0aWFsaXplcic7XHJcblxyXG5pbXBvcnQgeyBFVUxFUiwgUE9PTF9NQVggfSBmcm9tICcuLi9jb25zdGFudHMnO1xyXG5pbXBvcnQge1xyXG4gIElOSVRJQUxJWkVSX1RZUEVTX1RIQVRfUkVRVUlSRV9USFJFRSxcclxuICBTVVBQT1JURURfSlNPTl9CRUhBVklPVVJfVFlQRVMsXHJcbiAgU1VQUE9SVEVEX0pTT05fSU5JVElBTElaRVJfVFlQRVMsXHJcbn0gZnJvbSAnLi9jb25zdGFudHMnO1xyXG5cclxuaW1wb3J0IFJhdGUgZnJvbSAnLi4vaW5pdGlhbGl6ZXIvUmF0ZSc7XHJcbmltcG9ydCBUZXh0dXJlSW5pdGlhbGl6ZXIgZnJvbSAnLi4vaW5pdGlhbGl6ZXIvVGV4dHVyZSc7XHJcblxyXG5jb25zdCBERUZBVUxUX09QVElPTlMgPSB7IHNob3VsZEF1dG9FbWl0OiB0cnVlIH07XHJcblxyXG4vKipcclxuICogTWFrZXMgYSByYXRlIGluc3RhbmNlLlxyXG4gKlxyXG4gKiBAcGFyYW0ge29iamVjdH0ganNvbiAtIFRoZSBkYXRhIHJlcXVpcmVkIHRvIGNvbnN0cnVjdCBhIFJhdGUgaW5zdGFuY2VcclxuICogQHJldHVybiB7UmF0ZX1cclxuICovXHJcbmNvbnN0IG1ha2VSYXRlID0ganNvbiA9PiBSYXRlLmZyb21KU09OKGpzb24pO1xyXG5cclxuLyoqXHJcbiAqIE1ha2VzIGluaXRpYWxpemVycyBmcm9tIGpzb24gaXRlbXMuXHJcbiAqXHJcbiAqIEBwYXJhbSB7YXJyYXk8b2JqZWN0Pn0gaXRlbXMgLSBBbiBhcnJheSBvZiBvYmplY3RzIHdoaWNoIHByb3ZpZGUgaW5pdGlhbGl6ZXIgY29uc3RydWN0b3IgcGFyYW1zXHJcbiAqIEBwYXJhbSB7b2JqZWN0fSBUSFJFRSAtIFRoZSBXZWIgR0wgQXBpIHRvIHVzZVxyXG4gKiBAcmV0dXJuIHthcnJheTxJbml0aWFsaXplcj59XHJcbiAqL1xyXG5jb25zdCBtYWtlSW5pdGlhbGl6ZXJzID0gKGl0ZW1zLCBUSFJFRSkgPT5cclxuICBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICBpZiAoIWl0ZW1zLmxlbmd0aCkge1xyXG4gICAgICByZXR1cm4gcmVzb2x2ZShbXSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbnVtYmVyT2ZJbml0aWFsaXplcnMgPSBpdGVtcy5sZW5ndGg7XHJcbiAgICBjb25zdCBtYWRlSW5pdGlhbGl6ZXJzID0gW107XHJcbiAgICBjb25zdCBkb05vdFJlcXVpcmVUZXh0dXJlTG9hZGluZyA9IGl0ZW1zLmZpbHRlcihcclxuICAgICAgKHsgcHJvcGVydGllcyB9KSA9PiAhcHJvcGVydGllcy50ZXh0dXJlXHJcbiAgICApO1xyXG4gICAgY29uc3QgZG9SZXF1aXJlVGV4dHVyZUxvYWRpbmcgPSBpdGVtcy5maWx0ZXIoXHJcbiAgICAgICh7IHByb3BlcnRpZXMgfSkgPT4gcHJvcGVydGllcy50ZXh0dXJlXHJcbiAgICApO1xyXG5cclxuICAgIGRvTm90UmVxdWlyZVRleHR1cmVMb2FkaW5nLmZvckVhY2goZGF0YSA9PiB7XHJcbiAgICAgIGNvbnN0IHsgdHlwZSwgcHJvcGVydGllcyB9ID0gZGF0YTtcclxuXHJcbiAgICAgIGlmICghU1VQUE9SVEVEX0pTT05fSU5JVElBTElaRVJfVFlQRVMuaW5jbHVkZXModHlwZSkpIHtcclxuICAgICAgICByZXR1cm4gcmVqZWN0KFxyXG4gICAgICAgICAgYFRoZSBpbml0aWFsaXplciB0eXBlICR7dHlwZX0gaXMgaW52YWxpZCBvciBub3QgeWV0IHN1cHBvcnRlZGBcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoSU5JVElBTElaRVJfVFlQRVNfVEhBVF9SRVFVSVJFX1RIUkVFLmluY2x1ZGVzKHR5cGUpKSB7XHJcbiAgICAgICAgbWFkZUluaXRpYWxpemVycy5wdXNoKEluaXRpYWxpemVyW3R5cGVdLmZyb21KU09OKHByb3BlcnRpZXMsIFRIUkVFKSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgbWFkZUluaXRpYWxpemVycy5wdXNoKEluaXRpYWxpemVyW3R5cGVdLmZyb21KU09OKHByb3BlcnRpZXMpKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKG1hZGVJbml0aWFsaXplcnMubGVuZ3RoID09PSBudW1iZXJPZkluaXRpYWxpemVycykge1xyXG4gICAgICAgIHJldHVybiByZXNvbHZlKG1hZGVJbml0aWFsaXplcnMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBkb1JlcXVpcmVUZXh0dXJlTG9hZGluZy5mb3JFYWNoKGRhdGEgPT4ge1xyXG4gICAgICBjb25zdCB7XHJcbiAgICAgICAgdHlwZSxcclxuICAgICAgICBwcm9wZXJ0aWVzLFxyXG4gICAgICAgIHByb3BlcnRpZXM6IHsgdGV4dHVyZSB9LFxyXG4gICAgICB9ID0gZGF0YTtcclxuICAgICAgY29uc3QgdGV4dHVyZUxvYWRlciA9IG5ldyBUSFJFRS5UZXh0dXJlTG9hZGVyKCk7XHJcblxyXG4gICAgICBpZiAoIVNVUFBPUlRFRF9KU09OX0lOSVRJQUxJWkVSX1RZUEVTLmluY2x1ZGVzKHR5cGUpKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlamVjdChcclxuICAgICAgICAgIGBUaGUgaW5pdGlhbGl6ZXIgdHlwZSAke3R5cGV9IGlzIGludmFsaWQgb3Igbm90IHlldCBzdXBwb3J0ZWRgXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGV4dHVyZUxvYWRlci5sb2FkKFxyXG4gICAgICAgIHRleHR1cmUsXHJcbiAgICAgICAgbG9hZGVkVGV4dHVyZSA9PiB7XHJcbiAgICAgICAgICBtYWRlSW5pdGlhbGl6ZXJzLnB1c2goXHJcbiAgICAgICAgICAgIFRleHR1cmVJbml0aWFsaXplci5mcm9tSlNPTihcclxuICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAuLi5wcm9wZXJ0aWVzLFxyXG4gICAgICAgICAgICAgICAgbG9hZGVkVGV4dHVyZSxcclxuICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgIFRIUkVFXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgaWYgKG1hZGVJbml0aWFsaXplcnMubGVuZ3RoID09PSBudW1iZXJPZkluaXRpYWxpemVycykge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShtYWRlSW5pdGlhbGl6ZXJzKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIHVuZGVmaW5lZCxcclxuICAgICAgICByZWplY3RcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuLyoqXHJcbiAqIE1ha2VzIGJlaGF2aW91cnMgZnJvbSBqc29uIGl0ZW1zLlxyXG4gKlxyXG4gKiBAcGFyYW0ge2FycmF5PG9iamVjdD59IGl0ZW1zIC0gQW4gYXJyYXkgb2Ygb2JqZWN0cyB3aGljaCBwcm92aWRlIGJlaGF2aW91ciBjb25zdHJ1Y3RvciBwYXJhbXNcclxuICogQHJldHVybiB7UHJvbWlzZTxhcnJheT59XHJcbiAqL1xyXG5jb25zdCBtYWtlQmVoYXZpb3VycyA9IGl0ZW1zID0+XHJcbiAgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgaWYgKCFpdGVtcy5sZW5ndGgpIHtcclxuICAgICAgcmV0dXJuIHJlc29sdmUoW10pO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG51bWJlck9mQmVoYXZpb3VycyA9IGl0ZW1zLmxlbmd0aDtcclxuICAgIGNvbnN0IG1hZGVCZWhhdmlvdXJzID0gW107XHJcblxyXG4gICAgaXRlbXMuZm9yRWFjaChkYXRhID0+IHtcclxuICAgICAgY29uc3QgeyB0eXBlLCBwcm9wZXJ0aWVzIH0gPSBkYXRhO1xyXG5cclxuICAgICAgaWYgKCFTVVBQT1JURURfSlNPTl9CRUhBVklPVVJfVFlQRVMuaW5jbHVkZXModHlwZSkpIHtcclxuICAgICAgICByZXR1cm4gcmVqZWN0KFxyXG4gICAgICAgICAgYFRoZSBiZWhhdmlvdXIgdHlwZSAke3R5cGV9IGlzIGludmFsaWQgb3Igbm90IHlldCBzdXBwb3J0ZWRgXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgbWFkZUJlaGF2aW91cnMucHVzaChCZWhhdmlvdXJbdHlwZV0uZnJvbUpTT04ocHJvcGVydGllcykpO1xyXG5cclxuICAgICAgaWYgKG1hZGVCZWhhdmlvdXJzLmxlbmd0aCA9PT0gbnVtYmVyT2ZCZWhhdmlvdXJzKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlc29sdmUobWFkZUJlaGF2aW91cnMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbmNvbnN0IG1ha2VFbWl0dGVycyA9IChlbWl0dGVycywgRW1pdHRlciwgVEhSRUUsIHNob3VsZEF1dG9FbWl0KSA9PlxyXG4gIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgIGlmICghZW1pdHRlcnMubGVuZ3RoKSB7XHJcbiAgICAgIHJldHVybiByZXNvbHZlKFtdKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBtYWRlRW1pdHRlcnMgPSBbXTtcclxuICAgIGNvbnN0IG51bWJlck9mRW1pdHRlcnMgPSBlbWl0dGVycy5sZW5ndGg7XHJcblxyXG4gICAgaWYgKCFudW1iZXJPZkVtaXR0ZXJzKSB7XHJcbiAgICAgIHJldHVybiByZXNvbHZlKG1hZGVFbWl0dGVycyk7XHJcbiAgICB9XHJcblxyXG4gICAgZW1pdHRlcnMuZm9yRWFjaChkYXRhID0+IHtcclxuICAgICAgY29uc3QgZW1pdHRlciA9IG5ldyBFbWl0dGVyKCk7XHJcbiAgICAgIGNvbnN0IHtcclxuICAgICAgICByYXRlLFxyXG4gICAgICAgIHJvdGF0aW9uLFxyXG4gICAgICAgIGluaXRpYWxpemVycyxcclxuICAgICAgICBiZWhhdmlvdXJzLFxyXG4gICAgICAgIGVtaXR0ZXJCZWhhdmlvdXJzID0gW10sXHJcbiAgICAgICAgcG9zaXRpb24sXHJcbiAgICAgICAgdG90YWxFbWl0VGltZXMgPSBJbmZpbml0eSxcclxuICAgICAgICBsaWZlID0gSW5maW5pdHksXHJcbiAgICAgIH0gPSBkYXRhO1xyXG5cclxuICAgICAgZW1pdHRlclxyXG4gICAgICAgIC5zZXRSYXRlKG1ha2VSYXRlKHJhdGUpKVxyXG4gICAgICAgIC5zZXRSb3RhdGlvbihyb3RhdGlvbilcclxuICAgICAgICAuc2V0UG9zaXRpb24ocG9zaXRpb24pO1xyXG5cclxuICAgICAgbWFrZUluaXRpYWxpemVycyhpbml0aWFsaXplcnMsIFRIUkVFKVxyXG4gICAgICAgIC50aGVuKG1hZGVJbml0aWFsaXplcnMgPT4ge1xyXG4gICAgICAgICAgZW1pdHRlci5zZXRJbml0aWFsaXplcnMobWFkZUluaXRpYWxpemVycyk7XHJcblxyXG4gICAgICAgICAgcmV0dXJuIG1ha2VCZWhhdmlvdXJzKGJlaGF2aW91cnMpO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLnRoZW4obWFkZUJlaGF2aW91cnMgPT4ge1xyXG4gICAgICAgICAgZW1pdHRlci5zZXRCZWhhdmlvdXJzKG1hZGVCZWhhdmlvdXJzKTtcclxuXHJcbiAgICAgICAgICByZXR1cm4gbWFrZUJlaGF2aW91cnMoZW1pdHRlckJlaGF2aW91cnMpO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLnRoZW4obWFkZUVtaXR0ZXJCZWhhdmlvdXJzID0+IHtcclxuICAgICAgICAgIGVtaXR0ZXIuc2V0RW1pdHRlckJlaGF2aW91cnMobWFkZUVtaXR0ZXJCZWhhdmlvdXJzKTtcclxuXHJcbiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGVtaXR0ZXIpO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLnRoZW4oZW1pdHRlciA9PiB7XHJcbiAgICAgICAgICBtYWRlRW1pdHRlcnMucHVzaChcclxuICAgICAgICAgICAgc2hvdWxkQXV0b0VtaXRcclxuICAgICAgICAgICAgICA/IGVtaXR0ZXIuZW1pdCh0b3RhbEVtaXRUaW1lcywgbGlmZSlcclxuICAgICAgICAgICAgICA6IGVtaXR0ZXIuc2V0VG90YWxFbWl0VGltZXModG90YWxFbWl0VGltZXMpLnNldExpZmUobGlmZSlcclxuICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgaWYgKG1hZGVFbWl0dGVycy5sZW5ndGggPT09IG51bWJlck9mRW1pdHRlcnMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUobWFkZUVtaXR0ZXJzKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICAgIC5jYXRjaChyZWplY3QpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4vKipcclxuICogQ3JlYXRlcyBhIFN5c3RlbSBpbnN0YW5jZSBmcm9tIGEgSlNPTiBvYmplY3QuXHJcbiAqXHJcbiAqIEBwYXJhbSB7b2JqZWN0fSBqc29uIC0gVGhlIEpTT04gdG8gY3JlYXRlIHRoZSBTeXN0ZW0gaW5zdGFuY2UgZnJvbVxyXG4gKiBAcGFyYW0ge251bWJlcn0ganNvbi5wcmVQYXJ0aWNsZXMgLSBUaGUgcHJlZGV0ZXJtaW5lZCBudW1iZXIgb2YgcGFydGljbGVzXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSBqc29uLmludGVncmF0aW9uVHlwZSAtIFRoZSBpbnRlZ3JhdGlvbiBhbGdvcml0aG0gdG8gdXNlXHJcbiAqIEBwYXJhbSB7YXJyYXk8b2JqZWN0Pn0ganNvbi5lbWl0dGVycyAtIFRoZSBlbWl0dGVycyBmb3IgdGhlIHN5c3RlbSBpbnN0YW5jZVxyXG4gKiBAcGFyYW0ge29iamVjdH0gVEhSRUUgLSBUaGUgV2ViIEdMIEFwaSB0byB1c2VcclxuICogQHBhcmFtIHtmdW5jdGlvbn0gU3lzdGVtIC0gVGhlIHN5c3RlbSBjbGFzc1xyXG4gKiBAcGFyYW0ge2Z1bmN0aW9ufSBFbWl0dGVyIC0gVGhlIGVtaXR0ZXIgY2xhc3NcclxuICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zPXt9XSAtIE9wdGlvbmFsIGNvbmZpZyBvcHRpb25zXHJcbiAqIEByZXR1cm4ge1Byb21pc2U8U3lzdGVtPn1cclxuICovXHJcbmV4cG9ydCBkZWZhdWx0IChqc29uLCBUSFJFRSwgU3lzdGVtLCBFbWl0dGVyLCBvcHRpb25zID0ge30pID0+XHJcbiAgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgY29uc3Qge1xyXG4gICAgICBwcmVQYXJ0aWNsZXMgPSBQT09MX01BWCxcclxuICAgICAgaW50ZWdyYXRpb25UeXBlID0gRVVMRVIsXHJcbiAgICAgIGVtaXR0ZXJzID0gW10sXHJcbiAgICB9ID0ganNvbjtcclxuICAgIGNvbnN0IHN5c3RlbSA9IG5ldyBTeXN0ZW0ocHJlUGFydGljbGVzLCBpbnRlZ3JhdGlvblR5cGUpO1xyXG4gICAgY29uc3QgeyBzaG91bGRBdXRvRW1pdCB9ID0geyAuLi5ERUZBVUxUX09QVElPTlMsIC4uLm9wdGlvbnMgfTtcclxuXHJcbiAgICBtYWtlRW1pdHRlcnMoZW1pdHRlcnMsIEVtaXR0ZXIsIFRIUkVFLCBzaG91bGRBdXRvRW1pdClcclxuICAgICAgLnRoZW4obWFkZUVtaXR0ZXJzID0+IHtcclxuICAgICAgICBjb25zdCBudW1iZXJPZkVtaXR0ZXJzID0gbWFkZUVtaXR0ZXJzLmxlbmd0aDtcclxuXHJcbiAgICAgICAgaWYgKCFudW1iZXJPZkVtaXR0ZXJzKSB7XHJcbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZShzeXN0ZW0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbWFkZUVtaXR0ZXJzLmZvckVhY2gobWFkZUVtaXR0ZXIgPT4ge1xyXG4gICAgICAgICAgc3lzdGVtLmFkZEVtaXR0ZXIobWFkZUVtaXR0ZXIpO1xyXG5cclxuICAgICAgICAgIGlmIChzeXN0ZW0uZW1pdHRlcnMubGVuZ3RoID09PSBudW1iZXJPZkVtaXR0ZXJzKSB7XHJcbiAgICAgICAgICAgIHJlc29sdmUoc3lzdGVtKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfSlcclxuICAgICAgLmNhdGNoKHJlamVjdCk7XHJcbiAgfSk7XHJcbiJdfQ==